var oJIRA_FDBCK={VERSION:"2.2.0",KNOWNHOST:{RCSB:"www.rcsb.org",PDB101:"pdb101.rcsb.org",SIERRA:"www4.rcsb.org",DEV:"jira-tc.rcsb.org"},URL:{JIRA_PROXY:{ROOT_DEV:"https://jira-proxy-dev.rcsb.org/",ROOT_PROD:"https://jira-proxy.rcsb.org/"},IMG_LOGO:{RCSB:"https://cdn.rcsb.org/rcsb-pdb/v2/common/images/rcsb_logo.png",PDB101:"https://cdn.rcsb.org/pdb101/common/images/logo-pdb101.png",WWPDB:"https://cdn.rcsb.org/rcsb-pdb/v2/common/images/Logo_wwpdb.png"},FDBCK_HTML_SRC:{DEV:"includes/jira-fdbck.html",RCSB:"https://cdn.rcsb.org/jira-feedback/includes/jira-fdbck.html"}},JIRA:{PROJKEY:{DEV:"TC",BETA:"RBT",PROD:"HELP"},ISSUETYPE:{DEV:"Task",PROD:"Bug"}},LOGGINGPREFIX:"JIRA-FEEDBACK: ",MAXUPLOADS:3,MAXFILESIZEBYTES:5e6,DEBUG:!1};function handleFileAttach(e,o){var t=document.forms.namedItem("feedbackfrm"),a=new FormData(t),r=o+"jiraproxyattchmnt",s=new XMLHttpRequest;s.open("POST",r,!0),s.onload=function(e){200==s.status?oJIRA_FDBCK.DEBUG&&console.log(oJIRA_FDBCK.LOGGINGPREFIX+"File(s) successfully uploaded."):console.error(oJIRA_FDBCK.LOGGINGPREFIX+"Error: "+s.status+" occurred when trying to upload file(s).")},a.append("issue",e),s.send(a)}function hostIsRcsbDomain(e){return!!/\.rcsb\.org$/.test(e)}function hostIsBetaSystem(e){var o=e.match(/(beta)|(dev)|(staging)|(testing)|(release)|(quickly)|(dev)/);return o?(oJIRA_FDBCK.DEBUG&&console.log(oJIRA_FDBCK.LOGGINGPREFIX+"Regex MATCHED ["+o[1]+"] with ["+e+"]"),!0):(oJIRA_FDBCK.DEBUG&&console.log(oJIRA_FDBCK.LOGGINGPREFIX+"Regex did not match any pattern with ["+e+"]"),!1)}function validateEmail(e){return!!/^[a-zA-Z0-9._\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,5}$/.test(e)}function clearValidationPrompts(){$(".has-error").removeClass("has-error"),$(".help-block").remove()}function maxFilesExceeded(){var e=$("#file");return parseInt(e.get(0).files.length)>oJIRA_FDBCK.MAXUPLOADS&&($("#file-group").addClass("has-error").append('<div class="help-block">Can only upload a maximum of '+oJIRA_FDBCK.MAXUPLOADS+" files.</div>"),!0)}function surpassFileSizeLimit(){var e=document.getElementById("file"),o=!1,t=[];if(0<e.files.length)for(var a=0;a<e.files.length;a++){var r=e.files[a];oJIRA_FDBCK.DEBUG&&console.log(oJIRA_FDBCK.LOGGINGPREFIX+"Current file: "+r.name+" is "+r.size+" bytes in size"),r.size>oJIRA_FDBCK.MAXFILESIZEBYTES&&(t.push(r.name),o=!0)}return o&&$("#file-group").addClass("has-error").append('<div class="help-block">Problem with file(s): '+t.join(", ")+". Individual file size cannot exceed "+oJIRA_FDBCK.MAXFILESIZEBYTES/1e6+" MB.</div>"),o}function problemWithReqdField(){var o=!1;return clearValidationPrompts(),$(".reqd").each(function(){var e=$(this).attr("id");$(this).val().length<1?(o=!0,$("#"+e+"-group").addClass("has-error").append('<div class="help-block">Required value missing</div>')):"email"===e&&(validateEmail($("#"+e).val())||(o=!0,$("#"+e+"-group").addClass("has-error").append('<div class="help-block">Not valid email format</div>')))}),o}$(function(){var e,D,o,t,a,r=document.location.hostname;switch(r){case oJIRA_FDBCK.KNOWNHOST.RCSB:e=oJIRA_FDBCK.URL.FDBCK_HTML_SRC.RCSB,D=oJIRA_FDBCK.URL.JIRA_PROXY.ROOT_PROD,o=oJIRA_FDBCK.URL.IMG_LOGO.RCSB,t=oJIRA_FDBCK.JIRA.PROJKEY.PROD,a=oJIRA_FDBCK.JIRA.ISSUETYPE.PROD;break;case oJIRA_FDBCK.KNOWNHOST.PDB101:e=oJIRA_FDBCK.URL.FDBCK_HTML_SRC.RCSB,D=oJIRA_FDBCK.URL.JIRA_PROXY.ROOT_PROD,o=oJIRA_FDBCK.URL.IMG_LOGO.PDB101,t=oJIRA_FDBCK.JIRA.PROJKEY.PROD,a=oJIRA_FDBCK.JIRA.ISSUETYPE.PROD;break;case oJIRA_FDBCK.KNOWNHOST.SIERRA:e=oJIRA_FDBCK.URL.FDBCK_HTML_SRC.RCSB,D=oJIRA_FDBCK.URL.JIRA_PROXY.ROOT_PROD,o=oJIRA_FDBCK.URL.IMG_LOGO.RCSB,t=oJIRA_FDBCK.JIRA.PROJKEY.PROD,a=oJIRA_FDBCK.JIRA.ISSUETYPE.PROD;break;case oJIRA_FDBCK.KNOWNHOST.DEV:e=oJIRA_FDBCK.URL.FDBCK_HTML_SRC.DEV,D=oJIRA_FDBCK.URL.JIRA_PROXY.ROOT_DEV,o=oJIRA_FDBCK.URL.IMG_LOGO.RCSB,t=oJIRA_FDBCK.JIRA.PROJKEY.DEV,a=oJIRA_FDBCK.JIRA.ISSUETYPE.DEV,oJIRA_FDBCK.DEBUG=!0;break;default:e=oJIRA_FDBCK.URL.FDBCK_HTML_SRC.RCSB,o=oJIRA_FDBCK.URL.IMG_LOGO.RCSB,oJIRA_FDBCK.DEBUG=!1,D=oJIRA_FDBCK.URL.JIRA_PROXY.ROOT_DEV,t=oJIRA_FDBCK.JIRA.PROJKEY.DEV,a=oJIRA_FDBCK.JIRA.ISSUETYPE.DEV,hostIsRcsbDomain(r)&&(hostIsBetaSystem(r)?(D=oJIRA_FDBCK.URL.JIRA_PROXY.ROOT_PROD,t=oJIRA_FDBCK.JIRA.PROJKEY.BETA):(D=oJIRA_FDBCK.URL.JIRA_PROXY.ROOT_PROD,t=oJIRA_FDBCK.JIRA.PROJKEY.PROD),a=oJIRA_FDBCK.JIRA.ISSUETYPE.PROD)}oJIRA_FDBCK.DEBUG&&(console.info(oJIRA_FDBCK.LOGGINGPREFIX+"Debug/Beta/Development mode engaged"),console.info(oJIRA_FDBCK.LOGGINGPREFIX+"Current host is: "+r),console.info(oJIRA_FDBCK.LOGGINGPREFIX+"Proxy: "+D),console.info(oJIRA_FDBCK.LOGGINGPREFIX+"Project: "+t),console.info(oJIRA_FDBCK)),console.info(oJIRA_FDBCK.LOGGINGPREFIX+"Version "+oJIRA_FDBCK.VERSION),$.get(e,function(e){$("#jira-fdbck").html(e),$(".modal-logo").attr("src",o),$("#projectkey").val(t),$("#issuetype").val(a),oJIRA_FDBCK.DEBUG&&console.log(oJIRA_FDBCK.LOGGINGPREFIX+"Ajax feedback html import was performed (feedback modal prepared).")}),$(document).on("click",".jira-fdbck-btn",function(){$("#jira-fdbck-modal").modal("show");var e=JSON.parse(localStorage.getItem("privacyPolicyAgreement"));document.getElementById("privacyPolicyAgreement").checked=e;var o=sessionStorage.getItem("fname");document.getElementById("fname").value=o;var t=sessionStorage.getItem("lname");document.getElementById("lname").value=t;var a=sessionStorage.getItem("email");document.getElementById("email").value=a,$("#jira-fdbck-submit").prop("disabled",!1)}),$(document).on("click","#privacyPolicyAgreement",function(e){e.target.checked?$("#jira-fdbck-submit").prop("disabled",!1):$("#jira-fdbck-submit").prop("disabled",!0)}),$("#jira-fdbck").on("show.bs.modal","#jira-fdbck-modal",function(){$("#feedbackfrm .form-control").val(""),$("#privacyPolicyAgreement").removeAttr("checked"),$("#maxuploads").text(oJIRA_FDBCK.MAXUPLOADS),clearValidationPrompts()}),$("#jira-fdbck").on("click","#jira-fdbck-submit",function(){var e=document.getElementById("fname"),o=document.getElementById("lname"),t=document.getElementById("email"),a=document.getElementById("privacyPolicyAgreement");(localStorage||sessionStorage)&&(sessionStorage.setItem("fname",e.value),sessionStorage.setItem("lname",o.value),sessionStorage.setItem("email",t.value),localStorage.setItem("privacyPolicyAgreement",a.checked)),$("#jira-fdbck-submit").prop("disabled",!0);var r={Location:window.location.href,"User-Agent":navigator.userAgent,Referrer:document.referrer,"Screen Resolution":screen.width+" x "+screen.height},s=JSON.stringify(r,null,4);if(oJIRA_FDBCK.DEBUG&&console.log(oJIRA_FDBCK.LOGGINGPREFIX+s),problemWithReqdField()||maxFilesExceeded()||surpassFileSizeLimit())return $("#jira-fdbck-submit").prop("disabled",!1),!1;var i="Not Provided/Declined to State",l=$("#instype").val();l&&1<l.length&&(i=l);var n="Not Provided/Declined to State",c=$("#role").val();c&&1<c.length&&(n=c);var R="Not Provided/Declined to State",d=$("#rsrch-intrst").val();d&&1<d.length&&(R=d);var I={fields:{project:{key:$("#projectkey").val()},summary:$("#subject").val(),description:$("#description").val(),issuetype:{name:$("#issuetype").val()},environment:s,customfield_10333:$("#fname").val(),customfield_10327:$("#lname").val(),customfield_10322:$("#email").val(),customfield_11116:{value:i},customfield_11117:{value:n},customfield_11118:{value:R}}},m=JSON.stringify(I);$.ajax({type:"POST",url:D+"jiraproxyissue",data:m,dataType:"json",contentType:"application/json",success:function(e){var o=e.key;oJIRA_FDBCK.DEBUG&&(console.log(oJIRA_FDBCK.LOGGINGPREFIX+" feedback submission completed."),console.log(oJIRA_FDBCK.LOGGINGPREFIX+"issueKey is: "+o)),0==document.getElementById("file").files.length?oJIRA_FDBCK.DEBUG&&console.log(oJIRA_FDBCK.LOGGINGPREFIX+"no files selected"):(oJIRA_FDBCK.DEBUG&&console.log(oJIRA_FDBCK.LOGGINGPREFIX+"File(s) were selected for upload."),handleFileAttach(o,D)),$("#jira-fdbck-modal").modal("hide"),$("#jira-cnfrm-modal").modal("show"),setTimeout(function(){$("#jira-cnfrm-modal").modal("hide")},5e3)},error:function(e,o,t){if(console.error(oJIRA_FDBCK.LOGGINGPREFIX+" feedback submission failed"),e.responseText&&1<e.responseText.length){var a=JSON.parse(e.responseText);console.error(oJIRA_FDBCK.LOGGINGPREFIX+" error on submit! "+JSON.stringify(a.errors))}var r="<p>Summary: "+I.fields.summary+"</p><p>Description: "+I.fields.description+"</p><p>First Name: "+I.fields.customfield_10333+"</p><p>Last Name: "+I.fields.customfield_10327+"</p><p>Email: "+I.fields.customfield_10322+"</p><p>Environment: "+I.fields.environment;$("#relaycontent").empty().append(r),$("#jira-fdbck-modal").modal("hide"),$("#jira-nosrvr-modal").modal("show")}})}),$(document).on("change",".reqd",function(e){var o=$(this).attr("id");1<$(this).val().length&&($("#"+o+"-group").removeClass("has-error"),$("#"+o+"-group .help-block").remove())}),$(document).on("change","#file",function(e){parseInt($(this).get(0).files.length)>oJIRA_FDBCK.MAXUPLOADS?$("#file-group").addClass("has-error").append('<div class="help-block">Can only upload a maximum of '+oJIRA_FDBCK.MAXUPLOADS+" files.</div>"):($("#file-group").removeClass("has-error"),$("#file-group .help-block").remove())})});